
Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# Create Form
$form = New-Object System.Windows.Forms.Form
$form.Text = "Artifactory File Uploader"
$form.Size = New-Object System.Drawing.Size(550,450)
$form.StartPosition = "CenterScreen"

# Artifactory URL Label and TextBox
$lblArtifactoryUrl = New-Object System.Windows.Forms.Label
$lblArtifactoryUrl.Text = "Artifactory URL:"
$lblArtifactoryUrl.Location = New-Object System.Drawing.Point(20,20)
$form.Controls.Add($lblArtifactoryUrl)

$txtArtifactoryUrl = New-Object System.Windows.Forms.TextBox
$txtArtifactoryUrl.Location = New-Object System.Drawing.Point(140,18)
$txtArtifactoryUrl.Width = 300
$txtArtifactoryUrl.Text = "https://your-artifactory-instance.com"
$form.Controls.Add($txtArtifactoryUrl)

# Username Label and TextBox
$lblUser = New-Object System.Windows.Forms.Label
$lblUser.Text = "Username:"
$lblUser.Location = New-Object System.Drawing.Point(20,60)
$form.Controls.Add($lblUser)

$txtUser = New-Object System.Windows.Forms.TextBox
$txtUser.Location = New-Object System.Drawing.Point(140,58)
$txtUser.Width = 200
$form.Controls.Add($txtUser)

# Password Label and TextBox
$lblPass = New-Object System.Windows.Forms.Label
$lblPass.Text = "Password:"
$lblPass.Location = New-Object System.Drawing.Point(20,100)
$form.Controls.Add($lblPass)

$txtPass = New-Object System.Windows.Forms.TextBox
$txtPass.Location = New-Object System.Drawing.Point(140,98)
$txtPass.Width = 200
$txtPass.PasswordChar = '*'
$form.Controls.Add($txtPass)

# Login Button
$btnLogin = New-Object System.Windows.Forms.Button
$btnLogin.Text = "Login"
$btnLogin.Location = New-Object System.Drawing.Point(360, 78)
$form.Controls.Add($btnLogin)

# Repository Dropdown
$lblRepo = New-Object System.Windows.Forms.Label
$lblRepo.Text = "Select Repository:"
$lblRepo.Location = New-Object System.Drawing.Point(20,140)
$form.Controls.Add($lblRepo)

$cmbRepo = New-Object System.Windows.Forms.ComboBox
$cmbRepo.Location = New-Object System.Drawing.Point(140,138)
$cmbRepo.Width = 250
$form.Controls.Add($cmbRepo)

# File Selection
$lblFile = New-Object System.Windows.Forms.Label
$lblFile.Text = "Select File:"
$lblFile.Location = New-Object System.Drawing.Point(20,180)
$form.Controls.Add($lblFile)

$txtFilePath = New-Object System.Windows.Forms.TextBox
$txtFilePath.Location = New-Object System.Drawing.Point(140,178)
$txtFilePath.Width = 250
$form.Controls.Add($txtFilePath)

$btnBrowse = New-Object System.Windows.Forms.Button
$btnBrowse.Text = "Browse"
$btnBrowse.Location = New-Object System.Drawing.Point(400,176)
$form.Controls.Add($btnBrowse)

# Upload As Dropdown
$lblUploader = New-Object System.Windows.Forms.Label
$lblUploader.Text = "Upload As:"
$lblUploader.Location = New-Object System.Drawing.Point(20,220)
$form.Controls.Add($lblUploader)

$cmbUploader = New-Object System.Windows.Forms.ComboBox
$cmbUploader.Location = New-Object System.Drawing.Point(140,218)
$cmbUploader.Width = 250
$cmbUploader.Items.AddRange(@("User1", "User2", "User3")) # Modify with actual users
$form.Controls.Add($cmbUploader)

# Upload Button
$btnUpload = New-Object System.Windows.Forms.Button
$btnUpload.Text = "Upload"
$btnUpload.Location = New-Object System.Drawing.Point(200, 260)
$form.Controls.Add($btnUpload)

# Function to get repositories from Artifactory
function Get-ArtifactoryRepositories {
    param (
        [string]$artifactoryUrl,
        [string]$user,
        [string]$password
    )

    $apiEndpoint = "$artifactoryUrl/api/repositories"
    $pair = "$user`:$password"
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($pair)
    $base64 = [System.Convert]::ToBase64String($bytes)
    $headers = @{Authorization = "Basic $base64"}

    try {
        $response = Invoke-RestMethod -Uri $apiEndpoint -Headers $headers -Method Get
        return $response | ForEach-Object { $_.key }
    } catch {
        [System.Windows.Forms.MessageBox]::Show("Error retrieving repositories: $_", "Error", "OK", "Error")
        return @()
    }
}

# Login Button Click Event
$btnLogin.Add_Click({
    if (-not $txtArtifactoryUrl.Text -or -not $txtUser.Text -or -not $txtPass.Text) {
        [System.Windows.Forms.MessageBox]::Show("Please enter Artifactory URL, Username, and Password!", "Warning", "OK", "Warning")
        return
    }

    $repositories = Get-ArtifactoryRepositories -artifactoryUrl $txtArtifactoryUrl.Text -user $txtUser.Text -password $txtPass.Text
    $cmbRepo.Items.Clear()
    $cmbRepo.Items.AddRange($repositories)
})

# Browse Button Click Event
$btnBrowse.Add_Click({
    $openFileDialog = New-Object System.Windows.Forms.OpenFileDialog
    if ($openFileDialog.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
        $txtFilePath.Text = $openFileDialog.FileName
    }
})

# Upload Function
function Upload-ToArtifactory {
    param (
        [string]$artifactoryUrl,
        [string]$filePath,
        [string]$repo,
        [string]$user,
        [string]$password
    )

    if (-not (Test-Path $filePath)) {
        [System.Windows.Forms.MessageBox]::Show("File not found!", "Error", "OK", "Error")
        return
    }

    $fileName = [System.IO.Path]::GetFileName($filePath)
    $destinationUrl = "$artifactoryUrl/$repo/$fileName"

    $pair = "$user`:$password"
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($pair)
    $base64 = [System.Convert]::ToBase64String($bytes)
    $headers = @{Authorization = "Basic $base64"}

    try {
        Invoke-RestMethod -Uri $destinationUrl -Headers $headers -Method Put -InFile $filePath -ContentType "application/octet-stream"
        [System.Windows.Forms.MessageBox]::Show("Upload Successful!", "Success", "OK", "Information")
    } catch {
        [System.Windows.Forms.MessageBox]::Show("Upload Failed: $_", "Error", "OK", "Error")
    }
}

# Upload Button Click Event
$btnUpload.Add_Click({
    if (-not $txtArtifactoryUrl.Text -or -not $txtFilePath.Text -or -not $cmbRepo.SelectedItem) {
        [System.Windows.Forms.MessageBox]::Show("Please enter Artifactory URL, select a file, and choose a repository!", "Warning", "OK", "Warning")
        return
    }

    Upload-ToArtifactory -artifactoryUrl $txtArtifactoryUrl.Text -filePath $txtFilePath.Text -repo $cmbRepo.SelectedItem -user $txtUser.Text -password $txtPass.Text
})

# Run the Form
$form.ShowDialog()
